name: Convert V2Ray Rules to SRS/MRS

on:
  schedule:
    - cron: '0 2 * * *' # 每天 UTC 2:00 (北京时间 10:00) 运行
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Tools
        run: |
          # 1. 安装 v2dat (用于解压 dat)
          go install github.com/urlesistiana/v2dat@latest
          
          # 2. 安装 Sing-box (用于编译 srs)
          SB_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | jq -r .tag_name | sed 's/v//')
          wget -O sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SB_VERSION}/sing-box-${SB_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          chmod +x /usr/local/bin/sing-box
          
          # 3. 安装 Mihomo (用于编译 mrs)
          MIHOMO_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r .tag_name)
          wget -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          gunzip mihomo.gz
          sudo mv mihomo /usr/local/bin/
          chmod +x /usr/local/bin/mihomo

      - name: Download DAT files
        run: |
          wget -O geoip.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -O geosite.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat

      - name: Process and Compile
        shell: python
        run: |
          import os
          import subprocess
          import json
          import yaml
          import shutil

          # 配置
          OUTPUT_DIR = "rule-set"
          TEMP_DIR = "temp_extract"
          
          # 确保目录存在
          if os.path.exists(OUTPUT_DIR):
              shutil.rmtree(OUTPUT_DIR)
          os.makedirs(f"{OUTPUT_DIR}/geoip", exist_ok=True)
          os.makedirs(f"{OUTPUT_DIR}/geosite", exist_ok=True)
          
          if os.path.exists(TEMP_DIR):
              shutil.rmtree(TEMP_DIR)
          os.makedirs(TEMP_DIR, exist_ok=True)

          def run_command(cmd):
              subprocess.run(cmd, shell=True, check=True)

          # 1. 解压 DAT 文件
          print("Unpacking geoip.dat...")
          run_command(f"$(go env GOPATH)/bin/v2dat unpack geoip.dat -o {TEMP_DIR}/geoip")
          
          print("Unpacking geosite.dat...")
          run_command(f"$(go env GOPATH)/bin/v2dat unpack geosite.dat -o {TEMP_DIR}/geosite")

          # 2. 处理函数
          def process_category(category_path, type_name, output_subdir):
              filename = os.path.basename(category_path)
              rule_name = filename  # e.g., 'google' or 'cn'
              
              with open(category_path, 'r', encoding='utf-8') as f:
                  lines = [line.strip() for line in f if line.strip()]

              # --- A. 生成 Mihomo (YAML + MRS) ---
              # Mihomo YAML 格式非常简单，只有 payload
              mihomo_yaml = {"payload": lines}
              yaml_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.yaml"
              mrs_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.mrs"
              
              with open(yaml_path, 'w', encoding='utf-8') as f:
                  yaml.dump(mihomo_yaml, f, default_flow_style=False)
              
              # 编译 MRS
              # 命令格式: mihomo convert-ruleset <type> <yaml_path> <mrs_path>
              # type: domain (for geosite) or ipcidr (for geoip)
              mihomo_type = "domain" if type_name == "geosite" else "ipcidr"
              try:
                  run_command(f"mihomo convert-ruleset {mihomo_type} {yaml_path} {mrs_path}")
              except subprocess.CalledProcessError:
                  print(f"Failed to compile MRS for {rule_name}")

              # --- B. 生成 Sing-box (JSON + SRS) ---
              # Sing-box JSON 需要区分规则类型
              sb_rules = []
              
              if type_name == "geoip":
                  # GeoIP 全是 IP CIDR
                  sb_rules.append({"ip_cidr": lines})
              else:
                  # GeoSite 需要解析前缀 (full:, regexp:, domain:)
                  domain_suffix = []
                  domain_full = []
                  domain_regex = []
                  domain_keyword = []
                  
                  for line in lines:
                      if line.startswith("full:"):
                          domain_full.append(line[5:])
                      elif line.startswith("regexp:"):
                          domain_regex.append(line[7:])
                      elif line.startswith("domain:"): # v2dat 可能会保留这个前缀
                          domain_suffix.append(line[7:])
                      elif line.startswith("keyword:"):
                          domain_keyword.append(line[8:])
                      else:
                          domain_suffix.append(line) # 默认为 suffix
                  
                  rule_item = {}
                  if domain_suffix: rule_item["domain_suffix"] = domain_suffix
                  if domain_full: rule_item["domain"] = domain_full
                  if domain_regex: rule_item["domain_regex"] = domain_regex
                  if domain_keyword: rule_item["domain_keyword"] = domain_keyword
                  
                  if rule_item:
                      sb_rules.append(rule_item)

              sb_json = {
                  "version": 1,
                  "rules": sb_rules
              }
              json_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.json"
              srs_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.srs"
              
              with open(json_path, 'w', encoding='utf-8') as f:
                  json.dump(sb_json, f, indent=2)
              
              # 编译 SRS
              try:
                  run_command(f"sing-box rule-set compile --output {srs_path} {json_path}")
              except subprocess.CalledProcessError:
                  print(f"Failed to compile SRS for {rule_name}")

          # 3. 执行循环
          print("Processing GeoIP files...")
          geoip_files = os.listdir(f"{TEMP_DIR}/geoip")
          for f in geoip_files:
              process_category(f"{TEMP_DIR}/geoip/{f}", "geoip", "geoip")

          print("Processing GeoSite files...")
          geosite_files = os.listdir(f"{TEMP_DIR}/geosite")
          for f in geosite_files:
              # 过滤掉一些奇怪的文件名或空文件
              process_category(f"{TEMP_DIR}/geosite/{f}", "geosite", "geosite")
          
          print("Done!")

      - name: Deploy to rule-set branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./rule-set
          publish_branch: rule-set
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update rulesets: ${{ github.sha }}'
