name: Convert V2Ray Rules to SRS/MRS

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # cache: 'pip' # 禁用缓存

      - name: Install Python Dependencies
        run: pip install PyYAML

      - name: Install Tools
        run: |
          go install github.com/urlesistiana/v2dat@latest
          
          # 安装 Sing-box
          SB_VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | jq -r .tag_name | sed 's/v//')
          wget -O sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SB_VERSION}/sing-box-${SB_VERSION}-linux-amd64.tar.gz"
          tar -xvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          chmod +x /usr/local/bin/sing-box
          
          # 安装 Mihomo
          MIHOMO_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r .tag_name)
          wget -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          gunzip mihomo.gz
          sudo mv mihomo /usr/local/bin/
          chmod +x /usr/local/bin/mihomo

      - name: Download DAT files
        run: |
          wget -O geoip.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -O geosite.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat

      - name: Process and Compile
        shell: python
        run: |
          import os
          import subprocess
          import json
          import yaml
          import shutil

          # --- 修改点1：输出目录设为当前目录 "." ---
          OUTPUT_DIR = "." 
          TEMP_DIR = "temp_extract"
          
          # 确保输出目录存在 (在当前目录下创建 geoip 和 geosite)
          os.makedirs(f"{OUTPUT_DIR}/geoip", exist_ok=True)
          os.makedirs(f"{OUTPUT_DIR}/geosite", exist_ok=True)
          
          # 清理并创建临时目录
          if os.path.exists(TEMP_DIR):
              shutil.rmtree(TEMP_DIR)
          os.makedirs(TEMP_DIR, exist_ok=True)
          os.makedirs(f"{TEMP_DIR}/geoip", exist_ok=True)
          os.makedirs(f"{TEMP_DIR}/geosite", exist_ok=True)

          def run_command(cmd):
              subprocess.run(cmd, shell=True, check=True)

          go_path = subprocess.check_output("go env GOPATH", shell=True).decode().strip()
          v2dat_path = os.path.join(go_path, "bin", "v2dat")

          print("Unpacking geoip.dat...")
          run_command(f"{v2dat_path} unpack geoip geoip.dat -o {TEMP_DIR}/geoip")
          
          print("Unpacking geosite.dat...")
          run_command(f"{v2dat_path} unpack geosite geosite.dat -o {TEMP_DIR}/geosite")

          def process_category(category_path, type_name, output_subdir):
              filename = os.path.basename(category_path)
              if filename.startswith(type_name + "_"):
                  rule_name = filename.replace(type_name + "_", "").replace(".txt", "")
              else:
                  rule_name = filename.replace(".txt", "")
              
              with open(category_path, 'r', encoding='utf-8') as f:
                  lines = [line.strip() for line in f if line.strip()]

              # --- A. 生成 Mihomo (YAML + MRS) ---
              mihomo_yaml = {"payload": lines}
              yaml_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.yaml"
              mrs_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.mrs"
              
              with open(yaml_path, 'w', encoding='utf-8') as f:
                  yaml.dump(mihomo_yaml, f, default_flow_style=False)
              
              mihomo_type = "domain" if type_name == "geosite" else "ipcidr"
              try:
                  # mihomo 编译命令
                  run_command(f"mihomo convert-ruleset {mihomo_type} yaml {yaml_path} {mrs_path}")
              except subprocess.CalledProcessError:
                  print(f"Failed to compile MRS for {rule_name}")

              # --- B. 生成 Sing-box (JSON + SRS) ---
              sb_rules = []
              
              if type_name == "geoip":
                  sb_rules.append({"ip_cidr": lines})
              else:
                  domain_suffix = []
                  domain_full = []
                  domain_regex = []
                  domain_keyword = []
                  
                  for line in lines:
                      if line.startswith("full:"):
                          domain_full.append(line[5:])
                      elif line.startswith("regexp:"):
                          domain_regex.append(line[7:])
                      elif line.startswith("domain:"):
                          domain_suffix.append(line[7:])
                      elif line.startswith("keyword:"):
                          domain_keyword.append(line[8:])
                      else:
                          domain_suffix.append(line)
                  
                  rule_item = {}
                  if domain_suffix: rule_item["domain_suffix"] = domain_suffix
                  if domain_full: rule_item["domain"] = domain_full
                  if domain_regex: rule_item["domain_regex"] = domain_regex
                  if domain_keyword: rule_item["domain_keyword"] = domain_keyword
                  
                  if rule_item:
                      sb_rules.append(rule_item)

              # --- 修改点2：Sing-box JSON 版本指定为 3 ---
              sb_json = {
                  "version": 3,
                  "rules": sb_rules
              }
              json_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.json"
              srs_path = f"{OUTPUT_DIR}/{output_subdir}/{rule_name}.srs"
              
              with open(json_path, 'w', encoding='utf-8') as f:
                  json.dump(sb_json, f, indent=2)
              
              try:
                  run_command(f"sing-box rule-set compile --output {srs_path} {json_path}")
              except subprocess.CalledProcessError:
                  print(f"Failed to compile SRS for {rule_name}")

          print("Processing GeoIP files...")
          geoip_files = os.listdir(f"{TEMP_DIR}/geoip")
          for f in geoip_files:
              process_category(f"{TEMP_DIR}/geoip/{f}", "geoip", "geoip")

          print("Processing GeoSite files...")
          geosite_files = os.listdir(f"{TEMP_DIR}/geosite")
          for f in geosite_files:
              process_category(f"{TEMP_DIR}/geosite/{f}", "geosite", "geosite")
          
          print("Done!")

      - name: Prepare Publish Directory
        run: |
          mkdir -p publish
          mv geoip publish/
          mv geosite publish/

      - name: Deploy to rule-set branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          publish_branch: rule-set
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update rulesets: ${{ github.sha }}'
